# æ¶æ„è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† Build Your Own Claude Code é¡¹ç›®çš„å®Œæ•´æ¶æ„è®¾è®¡ã€‚

## ç›®å½•

- [æ•´ä½“æ¶æ„åˆ†å±‚](#æ•´ä½“æ¶æ„åˆ†å±‚)
- [æ ¸å¿ƒç»„ä»¶å…³ç³»](#æ ¸å¿ƒç»„ä»¶å…³ç³»)
- [æ•°æ®æµå‘å›¾](#æ•°æ®æµå‘å›¾)
- [Agent çŠ¶æ€æœº](#agent-çŠ¶æ€æœº)
- [å·¥å…·ç³»ç»Ÿæ¶æ„](#å·¥å…·ç³»ç»Ÿæ¶æ„)
- [ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥](#ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥)
- [ç›®å½•ç»“æ„å±‚çº§](#ç›®å½•ç»“æ„å±‚çº§)
- [æ‰©å±•ç‚¹è®¾è®¡](#æ‰©å±•ç‚¹è®¾è®¡)

---

## æ•´ä½“æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLI Interface                          â”‚
â”‚                  (ç”¨æˆ·è¾“å…¥/è¾“å‡º, å‘½ä»¤å¤„ç†)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Enhanced Agent                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  State Manager      Context Manager    Tool Manager    â”‚ â”‚
â”‚  â”‚  (çŠ¶æ€è¿½è¸ª)         (ä¸Šä¸‹æ–‡ç®¡ç†)        (å·¥å…·ç¼–æ’)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  - å¯¹è¯å¾ªç¯æ§åˆ¶                                               â”‚
â”‚  - å¤šè½®äº¤äº’ç¼–æ’                                               â”‚
â”‚  - ç»Ÿè®¡ä¿¡æ¯æ”¶é›†                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Client  â”‚           â”‚   Tool Ecosystem     â”‚
    â”‚ Layer   â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â”‚
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚         â”‚              â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Anthropic â”‚  â”‚Built-in  â”‚ â”‚    MCP    â”‚ â”‚Commands  â”‚
    â”‚  Client  â”‚  â”‚  Tools   â”‚ â”‚  Adapter  â”‚ â”‚  System  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚         â”‚          â”‚
                     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”
                     â”‚MCP     â”‚ â”‚MCP     â”‚ â”‚  MCP   â”‚
                     â”‚Server1 â”‚ â”‚Server2 â”‚ â”‚Server3 â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„è¯´æ˜

- **CLI Interface**: ç”¨æˆ·äº¤äº’å±‚ï¼Œå¤„ç†è¾“å…¥è¾“å‡ºå’Œå‘½ä»¤è§£æ
- **Enhanced Agent**: æ ¸å¿ƒæ§åˆ¶å±‚ï¼Œæ•´åˆä¸‰å¤§ç®¡ç†å™¨
- **Client Layer**: LLM å®¢æˆ·ç«¯æŠ½è±¡å±‚ï¼Œæ”¯æŒå¤šæ¨¡å‹
- **Tool Ecosystem**: å·¥å…·ç”Ÿæ€ç³»ç»Ÿï¼ŒåŒ…å«å†…ç½®å·¥å…·ã€MCP å·¥å…·å’Œå‘½ä»¤ç³»ç»Ÿ

---

## æ ¸å¿ƒç»„ä»¶å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EnhancedAgent                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  StateManager    â”‚  â”‚ ContextManager   â”‚               â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚               â”‚
â”‚  â”‚ â€¢ current_state  â”‚  â”‚ â€¢ messages       â”‚               â”‚
â”‚  â”‚ â€¢ tool_calls     â”‚  â”‚ â€¢ summary        â”‚               â”‚
â”‚  â”‚ â€¢ statistics     â”‚  â”‚ â€¢ metadata       â”‚               â”‚
â”‚  â”‚ â€¢ turn_count     â”‚  â”‚ â€¢ token_est      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚           ToolManager                        â”‚          â”‚
â”‚  â”‚                                              â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚          â”‚
â”‚  â”‚  â”‚ Built-in   â”‚         â”‚    MCP     â”‚      â”‚          â”‚
â”‚  â”‚  â”‚   Tools    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤   Client   â”‚      â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚          â”‚
â”‚  â”‚                                              â”‚          â”‚
â”‚  â”‚  â€¢ register_tool()                           â”‚          â”‚
â”‚  â”‚  â€¢ execute_tool() - æ™ºèƒ½é‡è¯•                  â”‚          â”‚
â”‚  â”‚  â€¢ get_tool_definitions()                    â”‚          â”‚
â”‚  â”‚  â€¢ usage_statistics                          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚            BaseClient                        â”‚          â”‚
â”‚  â”‚  â€¢ create_message()                          â”‚          â”‚
â”‚  â”‚  â€¢ generate_summary()                        â”‚          â”‚
â”‚  â”‚  â€¢ model_name, context_window                â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶èŒè´£

#### StateManager
- ç®¡ç† Agent è¿è¡ŒçŠ¶æ€ï¼ˆIDLE, THINKING, USING_TOOL, COMPLETED, ERRORï¼‰
- è®°å½•å·¥å…·è°ƒç”¨å†å²
- æ”¶é›†å’Œç»Ÿè®¡æ€§èƒ½æŒ‡æ ‡
- æ§åˆ¶å¯¹è¯è½®æ•°

#### ContextManager
- ç®¡ç†å¯¹è¯æ¶ˆæ¯å†å²
- ä¼°ç®— Token ä½¿ç”¨é‡
- è‡ªåŠ¨å‹ç¼©å’Œæ‘˜è¦åŒ–
- ç»´æŠ¤å…ƒæ•°æ®

#### ToolManager
- æ³¨å†Œå’Œç®¡ç†æ‰€æœ‰å·¥å…·ï¼ˆå†…ç½® + MCPï¼‰
- æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼ˆå¸¦æ™ºèƒ½é‡è¯•ï¼‰
- ç»Ÿè®¡å·¥å…·ä½¿ç”¨æƒ…å†µ
- æä¾›ç»Ÿä¸€çš„å·¥å…·æ¥å£

---

## æ•°æ®æµå‘å›¾

```
ç”¨æˆ·è¾“å…¥ "Create a hello.py file"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLI å‘½ä»¤æ£€æŸ¥                        â”‚
â”‚  Is command? No â†’ ç»§ç»­               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EnhancedAgent.run()                â”‚
â”‚  â€¢ StateManager â†’ THINKING          â”‚
â”‚  â€¢ ContextManager.add_user_message  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context å‹ç¼©æ£€æŸ¥                    â”‚
â”‚  â€¢ estimate_tokens()                â”‚
â”‚  â€¢ compress_if_needed()             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°ƒç”¨ LLM                            â”‚
â”‚  â€¢ Client.create_message()          â”‚
â”‚  â€¢ tools = ToolManager.get_defs()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§£æå“åº”                            â”‚
â”‚  â€¢ text_blocks: æ˜¾ç¤ºç»™ç”¨æˆ·           â”‚
â”‚  â€¢ tool_uses: æå–å·¥å…·è°ƒç”¨           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œå·¥å…·                            â”‚
â”‚  â€¢ StateManager â†’ USING_TOOL        â”‚
â”‚  â€¢ ToolManager.execute_tool()       â”‚
â”‚    - å†…ç½®å·¥å…· â†’ ToolExecutor        â”‚
â”‚    - MCPå·¥å…· â†’ MCPClient            â”‚
â”‚  â€¢ æ™ºèƒ½é‡è¯• (æœ€å¤š2æ¬¡)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ›´æ–°çŠ¶æ€                            â”‚
â”‚  â€¢ StateManager.record_tool_call()  â”‚
â”‚  â€¢ StateManager.add_tokens()        â”‚
â”‚  â€¢ ContextManager.add_results()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»§ç»­å¾ªç¯ or å®Œæˆ                    â”‚
â”‚  â€¢ æœ‰æ›´å¤šå·¥å…·è°ƒç”¨? â†’ ç»§ç»­            â”‚
â”‚  â€¢ æ— å·¥å…·è°ƒç”¨? â†’ COMPLETED          â”‚
â”‚  â€¢ è¶…è¿‡max_turns? â†’ ERROR           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Agent çŠ¶æ€æœº

```
          [å¯åŠ¨]
             â”‚
             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  IDLE  â”‚
         â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚ run()
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   THINKING   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
             â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
   â”‚ éœ€è¦è°ƒç”¨å·¥å…·?      â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
         â”‚ Yes  â”‚ No            â”‚
         â”‚      â”‚               â”‚
         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
         â”‚                      â”‚      â”‚
         â–¼                      â–¼      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ USING_TOOL  â”‚         â”‚  COMPLETED   â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ WAITING_FOR_     â”‚
  â”‚    RESULT        â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  [è¶…è¿‡max_turnsæˆ–å¼‚å¸¸]
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ERROR  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€è¯´æ˜

- **IDLE**: åˆå§‹çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥
- **THINKING**: LLM æ€è€ƒä¸­ï¼Œç”Ÿæˆå“åº”
- **USING_TOOL**: æ‰§è¡Œå·¥å…·è°ƒç”¨
- **WAITING_FOR_RESULT**: ç­‰å¾…å·¥å…·æ‰§è¡Œç»“æœ
- **COMPLETED**: ä»»åŠ¡å®Œæˆ
- **ERROR**: å‘ç”Ÿé”™è¯¯æˆ–è¶…è¿‡æœ€å¤§è½®æ•°

---

## å·¥å…·ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ToolManager                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           ToolExecutor (æ™ºèƒ½é‡è¯•)               â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚  for attempt in range(max_retries=2):    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    result = await tool.execute()         â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    if success: return result             â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    if non_retryable: break               â”‚   â”‚    â”‚
â”‚  â”‚  â”‚    await asyncio.sleep(backoff)          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  return error to Claude                  â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Built-in      â”‚              â”‚   MCP Tools      â”‚   â”‚
â”‚  â”‚  Tools         â”‚              â”‚                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ ReadTool     â”‚              â”‚ â€¢ mcp_fs_read    â”‚   â”‚
â”‚  â”‚ â€¢ WriteTool    â”‚              â”‚ â€¢ mcp_gh_pr      â”‚   â”‚
â”‚  â”‚ â€¢ EditTool     â”‚              â”‚ â€¢ mcp_db_query   â”‚   â”‚
â”‚  â”‚ â€¢ BashTool     â”‚              â”‚ â€¢ ...            â”‚   â”‚
â”‚  â”‚ â€¢ GlobTool     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ â€¢ GrepTool     â”‚                                     â”‚
â”‚  â”‚ â€¢ TodoWrite    â”‚                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ™ºèƒ½é‡è¯•æœºåˆ¶

1. **æœ€å¤šé‡è¯• 2 æ¬¡**: å¯¹äºå¯é‡è¯•çš„é”™è¯¯è‡ªåŠ¨é‡è¯•
2. **æŒ‡æ•°é€€é¿**: æ¯æ¬¡é‡è¯•é—´éš”é€’å¢ï¼ˆ0.5s, 1sï¼‰
3. **éé‡è¯•é”™è¯¯**: è¯†åˆ«ä¸åº”é‡è¯•çš„é”™è¯¯ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ã€æƒé™é”™è¯¯ç­‰ï¼‰
4. **å¤±è´¥åå†³ç­–**: æ‰€æœ‰é‡è¯•å¤±è´¥åï¼Œå°†é”™è¯¯è¿”å›ç»™ Claude è®©å…¶å†³ç­–

---

## ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ContextManager                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Messages: [msg1, msg2, ..., msgN]                      â”‚
â”‚  Summary: "Previous conversation summary..."            â”‚
â”‚  Max Tokens: 150,000 (80% of 200K)                      â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Token Estimation (æ¯æ¬¡å¯¹è¯å‰)                  â”‚     â”‚
â”‚  â”‚  â€¢ total = system + summary + messages         â”‚     â”‚
â”‚  â”‚  â€¢ chars â‰ˆ tokens * 3 (ä¿å®ˆä¼°è®¡)               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Auto Compression (è¶…è¿‡é˜ˆå€¼æ—¶)                  â”‚     â”‚
â”‚  â”‚                                                 â”‚     â”‚
â”‚  â”‚  [msg1...msg90] + [msg91...msg100]             â”‚     â”‚
â”‚  â”‚       â†“                    â†“                   â”‚     â”‚
â”‚  â”‚   ç”Ÿæˆæ‘˜è¦              ä¿ç•™æœ€è¿‘10æ¡             â”‚     â”‚
â”‚  â”‚       â†“                    â†“                   â”‚     â”‚
â”‚  â”‚   Summary         [msg91...msg100]             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‹ç¼©ç­–ç•¥

1. **Token ä¼°ç®—**: ä½¿ç”¨å­—ç¬¦æ•°ä¼°ç®—ï¼ˆ1 token â‰ˆ 3 charsï¼‰
2. **è§¦å‘æ¡ä»¶**: è¶…è¿‡ max_tokens (é»˜è®¤ 150K)
3. **ä¿ç•™ç­–ç•¥**: ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯
4. **æ‘˜è¦ç”Ÿæˆ**: ä½¿ç”¨ Claude ç”Ÿæˆæ—§æ¶ˆæ¯æ‘˜è¦
5. **æ‘˜è¦å†…å®¹**: å…³æ³¨æ–‡ä»¶ä¿®æ”¹ã€å‘½ä»¤æ‰§è¡Œã€å…³é”®å†³ç­–ã€ä»»åŠ¡çŠ¶æ€

---

## ç›®å½•ç»“æ„å±‚çº§

```
src/
â”œâ”€â”€ agents/                 # ğŸ§  Agent æ ¸å¿ƒå±‚
â”‚   â”œâ”€â”€ enhanced_agent.py   # ä¸» Agent (æ•´åˆæ‰€æœ‰ç®¡ç†å™¨)
â”‚   â”œâ”€â”€ state.py            # çŠ¶æ€ç®¡ç† (FSM + ç»Ÿè®¡)
â”‚   â”œâ”€â”€ context_manager.py  # ä¸Šä¸‹æ–‡ç®¡ç† (å‹ç¼© + æ‘˜è¦)
â”‚   â””â”€â”€ tool_manager.py     # å·¥å…·ç®¡ç† (æ³¨å†Œ + æ‰§è¡Œ)
â”‚
â”œâ”€â”€ clients/                # ğŸŒ LLM å®¢æˆ·ç«¯å±‚
â”‚   â”œâ”€â”€ base.py             # æŠ½è±¡æ¥å£
â”‚   â””â”€â”€ anthropic.py        # Anthropic å®ç°
â”‚
â”œâ”€â”€ tools/                  # ğŸ› ï¸ å·¥å…·å±‚
â”‚   â”œâ”€â”€ base.py             # å·¥å…·åŸºç±»
â”‚   â”œâ”€â”€ file_ops.py         # æ–‡ä»¶æ“ä½œå·¥å…·
â”‚   â”œâ”€â”€ bash.py             # å‘½ä»¤æ‰§è¡Œå·¥å…·
â”‚   â”œâ”€â”€ search.py           # æœç´¢å·¥å…·
â”‚   â””â”€â”€ todo.py             # Todo ç®¡ç†å·¥å…·
â”‚
â”œâ”€â”€ commands/               # âŒ¨ï¸ å‘½ä»¤å±‚
â”‚   â”œâ”€â”€ base.py             # å‘½ä»¤åŸºç±» + æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ builtin.py          # å†…ç½®å‘½ä»¤
â”‚   â””â”€â”€ persistence_commands.py  # æŒä¹…åŒ–å‘½ä»¤
â”‚
â”œâ”€â”€ mcp_integration.py      # ğŸ”Œ MCP é›†æˆå±‚
â”œâ”€â”€ persistence.py          # ğŸ’¾ æŒä¹…åŒ–å±‚
â”œâ”€â”€ registry.py             # ğŸ“‹ å·¥å…·æ³¨å†Œå±‚
â”œâ”€â”€ prompt.py               # ğŸ“ Prompt å±‚
â””â”€â”€ main.py                 # ğŸš€ å…¥å£å±‚
```

### å±‚çº§è¯´æ˜

- **Agent æ ¸å¿ƒå±‚**: æœ€æ ¸å¿ƒçš„ Agent å®ç°å’Œç®¡ç†å™¨
- **LLM å®¢æˆ·ç«¯å±‚**: ä¸ LLM æœåŠ¡å•†çš„äº¤äº’æŠ½è±¡
- **å·¥å…·å±‚**: å®é™…æ‰§è¡Œä»»åŠ¡çš„å·¥å…·é›†åˆ
- **å‘½ä»¤å±‚**: CLI å‘½ä»¤ç³»ç»Ÿ
- **é›†æˆå±‚**: MCPã€æŒä¹…åŒ–ç­‰å¤–éƒ¨é›†æˆ
- **å…¥å£å±‚**: åº”ç”¨å¯åŠ¨å’Œåˆå§‹åŒ–

---

## æ‰©å±•ç‚¹è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ‰©å±•æ¥å£                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. æ–°å¢ LLM Provider                                   â”‚
â”‚     â””â”€ å®ç° BaseClient æ¥å£                             â”‚
â”‚        â€¢ create_message()                               â”‚
â”‚        â€¢ generate_summary()                             â”‚
â”‚        â€¢ model_name, context_window                     â”‚
â”‚                                                         â”‚
â”‚  2. æ–°å¢å·¥å…·                                            â”‚
â”‚     â””â”€ ç»§æ‰¿ BaseTool                                    â”‚
â”‚        â€¢ name, description, input_schema                â”‚
â”‚        â€¢ execute()                                      â”‚
â”‚        â€¢ register åˆ° ToolManager                        â”‚
â”‚                                                         â”‚
â”‚  3. æ–°å¢å‘½ä»¤                                            â”‚
â”‚     â””â”€ ç»§æ‰¿ Command                                     â”‚
â”‚        â€¢ name, description, aliases                     â”‚
â”‚        â€¢ execute()                                      â”‚
â”‚        â€¢ register åˆ° CommandRegistry                    â”‚
â”‚                                                         â”‚
â”‚  4. æ–°å¢ MCP æœåŠ¡å™¨                                     â”‚
â”‚     â””â”€ åœ¨ config.json é…ç½®                             â”‚
â”‚        â€¢ name, command, args, env                       â”‚
â”‚        â€¢ enabled: true/false                            â”‚
â”‚                                                         â”‚
â”‚  5. LangGraph é›†æˆ                                      â”‚
â”‚     â””â”€ åˆ©ç”¨ StateManager æ¥å£                          â”‚
â”‚        â€¢ ç›‘å¬çŠ¶æ€å˜åŒ–: on_state_change                  â”‚
â”‚        â€¢ è®¿é—®çŠ¶æ€: get_current_state()                  â”‚
â”‚        â€¢ è·å–ç»Ÿè®¡: get_statistics()                     â”‚
â”‚                                                         â”‚
â”‚  6. æµå¼è¾“å‡º                                            â”‚
â”‚     â””â”€ ä½¿ç”¨ BaseClient.create_message(stream=True)     â”‚
â”‚        â€¢ async for chunk in stream                      â”‚
â”‚        â€¢ å®æ—¶æ˜¾ç¤ºç»™ç”¨æˆ·                                  â”‚
â”‚                                                         â”‚
â”‚  7. è‡ªå®šä¹‰çŠ¶æ€é’©å­                                      â”‚
â”‚     â””â”€ EnhancedAgent(on_state_change=callback)         â”‚
â”‚        â€¢ def callback(old_state, new_state)             â”‚
â”‚        â€¢ å¯ç”¨äºæ—¥å¿—ã€ç›‘æ§ã€UI æ›´æ–°                       â”‚
â”‚                                                         â”‚
â”‚  8. è‡ªå®šä¹‰å‹ç¼©ç­–ç•¥                                      â”‚
â”‚     â””â”€ æ‰©å±• ContextManager                             â”‚
â”‚        â€¢ è‡ªå®šä¹‰ compress_if_needed()                    â”‚
â”‚        â€¢ è‡ªå®šä¹‰æ‘˜è¦ prompt                              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ‰©å±•ç¤ºä¾‹

#### æ·»åŠ æ–°çš„ LLM Provider

```python
from src.clients.base import BaseClient, ModelResponse

class OpenAIClient(BaseClient):
    async def create_message(self, system, messages, tools, **kwargs):
        # å®ç° OpenAI API è°ƒç”¨
        response = await openai.chat.completions.create(...)
        return ModelResponse(...)

    async def generate_summary(self, prompt):
        # å®ç°æ‘˜è¦ç”Ÿæˆ
        pass

    @property
    def model_name(self):
        return "gpt-4"

    @property
    def context_window(self):
        return 128000
```

#### æ·»åŠ æ–°å·¥å…·

```python
from src.tools.base import BaseTool, ToolResult

class WebSearchTool(BaseTool):
    @property
    def name(self):
        return "WebSearch"

    @property
    def description(self):
        return "Search the web for information"

    @property
    def input_schema(self):
        return {
            "type": "object",
            "properties": {
                "query": {"type": "string"}
            },
            "required": ["query"]
        }

    async def execute(self, query: str) -> ToolResult:
        # å®ç°ç½‘é¡µæœç´¢
        results = await search_web(query)
        return ToolResult(success=True, output=results)
```

#### é›†æˆ LangGraph

```python
from langgraph.graph import StateGraph
from src.agents import EnhancedAgent, AgentState

def create_langgraph_agent(agent: EnhancedAgent):
    workflow = StateGraph(AgentState)

    # å®šä¹‰èŠ‚ç‚¹
    workflow.add_node("think", agent.run)
    workflow.add_node("use_tool", lambda x: x)

    # å®šä¹‰è¾¹
    workflow.add_edge("think", "use_tool")
    workflow.add_edge("use_tool", "think")

    return workflow.compile()
```

---

## è®¾è®¡åŸåˆ™

### 1. å…³æ³¨ç‚¹åˆ†ç¦»
æ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„èŒè´£ï¼š
- StateManager åªç®¡çŠ¶æ€
- ContextManager åªç®¡ä¸Šä¸‹æ–‡
- ToolManager åªç®¡å·¥å…·

### 2. ä¾èµ–å€’ç½®
é€šè¿‡æŠ½è±¡æ¥å£è§£è€¦ï¼š
- BaseClient æŠ½è±¡ LLM æä¾›å•†
- BaseTool æŠ½è±¡å·¥å…·å®ç°
- Command æŠ½è±¡å‘½ä»¤å®ç°

### 3. å¼€æ”¾å°é—­
å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ï¼š
- æ–°å¢å·¥å…·ä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç 
- æ–°å¢ LLM æä¾›å•†ä¸å½±å“ Agent é€»è¾‘
- æ–°å¢å‘½ä»¤ä¸å½±å“ç°æœ‰å‘½ä»¤

### 4. å•ä¸€èŒè´£
æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªå˜åŒ–åŸå› ï¼š
- Agent åªå› å¯¹è¯æµç¨‹å˜åŒ–è€Œå˜åŒ–
- ToolManager åªå› å·¥å…·ç®¡ç†ç­–ç•¥å˜åŒ–è€Œå˜åŒ–
- ContextManager åªå› ä¸Šä¸‹æ–‡ç­–ç•¥å˜åŒ–è€Œå˜åŒ–

---

## æ€§èƒ½è€ƒè™‘

### Token ä½¿ç”¨ä¼˜åŒ–
1. **ä¼°ç®—è€Œéç²¾ç¡®è®¡ç®—**: é¿å…è°ƒç”¨ tokenizer API
2. **ä¿å®ˆä¼°è®¡**: å®å¯å¤šä¼°ä¸å°‘ä¼°
3. **æŒ‰éœ€å‹ç¼©**: åªåœ¨æ¥è¿‘é™åˆ¶æ—¶æ‰å‹ç¼©
4. **æ‰¹é‡æ“ä½œ**: ä¸€æ¬¡æ€§å¤„ç†å¤šæ¡æ¶ˆæ¯

### å·¥å…·æ‰§è¡Œä¼˜åŒ–
1. **æ™ºèƒ½é‡è¯•**: åªé‡è¯•å¯èƒ½æˆåŠŸçš„é”™è¯¯
2. **å¹¶è¡Œæ‰§è¡Œ**: æœªæ¥å¯æ”¯æŒå¹¶è¡Œå·¥å…·è°ƒç”¨
3. **ç»“æœç¼“å­˜**: å¯é€‰çš„å·¥å…·ç»“æœç¼“å­˜
4. **è¶…æ—¶æ§åˆ¶**: é˜²æ­¢å·¥å…·æ‰§è¡Œæ—¶é—´è¿‡é•¿

### å†…å­˜ç®¡ç†
1. **æ¶ˆæ¯å‹ç¼©**: è‡ªåŠ¨æ¸…ç†æ—§æ¶ˆæ¯
2. **æ‘˜è¦æ›¿ä»£**: ç”¨æ‘˜è¦æ›¿ä»£è¯¦ç»†å†å²
3. **æµå¼å¤„ç†**: å¤§æ–‡ä»¶ä½¿ç”¨æµå¼è¯»å–
4. **åŠæ—¶æ¸…ç†**: ä¼šè¯ç»“æŸåæ¸…ç†èµ„æº

---

## å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯
- æ–‡ä»¶è·¯å¾„éªŒè¯ï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰
- å‘½ä»¤æ³¨å…¥é˜²æŠ¤
- JSON Schema éªŒè¯å·¥å…·å‚æ•°

### 2. èµ„æºé™åˆ¶
- æœ€å¤§å¯¹è¯è½®æ•°é™åˆ¶
- å·¥å…·æ‰§è¡Œè¶…æ—¶
- æ–‡ä»¶å¤§å°é™åˆ¶
- Token ä½¿ç”¨é™åˆ¶

### 3. é”™è¯¯å¤„ç†
- æ•æ„Ÿä¿¡æ¯ä¸å†™å…¥æ—¥å¿—
- é”™è¯¯ä¿¡æ¯è„±æ•
- å¼‚å¸¸æ•è·å’Œæ¢å¤

### 4. æƒé™æ§åˆ¶
- å·¥å…·æ‰§è¡Œæƒé™æ£€æŸ¥
- æ–‡ä»¶è®¿é—®æƒé™æ§åˆ¶
- MCP æœåŠ¡å™¨è®¤è¯

---

## å¯æµ‹è¯•æ€§

### å•å…ƒæµ‹è¯•
æ¯ä¸ªç»„ä»¶éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼š
```python
# æµ‹è¯• StateManager
def test_state_transition():
    manager = AgentStateManager()
    manager.transition_to(AgentState.THINKING)
    assert manager.current_state == AgentState.THINKING

# æµ‹è¯• ToolManager
async def test_tool_execution():
    manager = AgentToolManager()
    manager.register_tool(MockTool())
    result = await manager.execute_tool("MockTool", {})
    assert result.success

# æµ‹è¯• ContextManager
async def test_context_compression():
    manager = AgentContextManager(max_tokens=100)
    # æ·»åŠ å¤§é‡æ¶ˆæ¯
    # éªŒè¯å‹ç¼©é€»è¾‘
```

### é›†æˆæµ‹è¯•
æµ‹è¯•ç»„ä»¶é—´äº¤äº’ï¼š
```python
async def test_agent_flow():
    agent = EnhancedAgent(client, system_prompt)
    agent.tool_manager.register_tools([...])
    result = await agent.run("Create a file")
    assert result["agent_state"]["state"] == "completed"
```

---

## æ€»ç»“

è¿™ä¸ªæ¶æ„è®¾è®¡çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. **æ¸…æ™°åˆ†å±‚**: èŒè´£æ˜ç¡®ï¼Œæ˜“äºç†è§£
2. **é«˜åº¦è§£è€¦**: ç»„ä»¶é—´ä¾èµ–æœ€å°åŒ–
3. **æ˜“äºæµ‹è¯•**: æ¯ä¸ªç»„ä»¶å¯ç‹¬ç«‹æµ‹è¯•
4. **æ‰©å±•æ€§å¼º**: å¤šä¸ªé¢„ç•™æ‰©å±•ç‚¹
5. **ç”Ÿäº§å°±ç»ª**: å®Œæ•´çš„é”™è¯¯å¤„ç†ã€ç›‘æ§ã€ç»Ÿè®¡

é€‚åˆä½œä¸ºï¼š
- **å­¦ä¹ é¡¹ç›®**: ç†è§£ AI Agent æ¶æ„
- **ç”Ÿäº§åŸºç¡€**: æ„å»ºå®é™…åº”ç”¨
- **ç ”ç©¶å¹³å°**: å®éªŒæ–°çš„ Agent ç­–ç•¥
